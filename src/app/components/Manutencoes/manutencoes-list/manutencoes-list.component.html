<div class="manutencoes-container">
  <!-- Header -->
  <div class="header">
    <div class="header-title">
      <mat-icon class="title-icon">build</mat-icon>
      <h2>Gerenciamento de Manutenções</h2>
    </div>
    <div class="header-actions">
      <button class="btn-reload" (click)="carregarDados()" [disabled]="carregando" title="Recarregar lista">
        <mat-icon>refresh</mat-icon>
      </button>
      <button class="btn-add" (click)="novaManutencao()">
        <mat-icon>add</mat-icon>
        Nova Manutenção
      </button>
    </div>
  </div>

  <!-- Estado de Carregamento -->
  <div *ngIf="carregando" class="loading-state">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Carregando...</span>
    </div>
    <h3>Carregando manutenções...</h3>
    <p>Aguarde enquanto carregamos a lista de manutenções</p>
  </div>

  <!-- Conteúdo Principal (quando não está carregando) -->
  <div *ngIf="!carregando">
    <!-- Alertas -->
    <div *ngIf="alertas.length > 0" class="alert-section">
      <div class="card">
        <div class="card-body">
          <h4 class="card-title">
            <mat-icon class="me-2">notifications</mat-icon>
            Alertas de Manutenção
          </h4>
          <div class="alertas-list">
            <div *ngFor="let alerta of alertas" class="alerta-item">
              <mat-icon class="alerta-icon">warning</mat-icon>
              <span class="alerta-text">{{alerta}}</span>
            </div>
          </div>
          <div class="alert-actions mt-3">
            <button class="btn-alerta" (click)="verManutencoesVencidas()">
              <mat-icon>visibility</mat-icon>
              Ver Vencidas
            </button>
            <button class="btn-alerta" (click)="verManutencoesProximas()">
              <mat-icon>schedule</mat-icon>
              Ver Próximas
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Formulário (quando aberto) -->
    <div *ngIf="mostrarFormulario" class="form-section">
      <div class="card">
        <div class="card-body">
          <div class="form-header">
            <h4 class="card-title">
              <mat-icon>{{editando ? 'edit' : 'add'}}</mat-icon>
              {{editando ? 'Editar Manutenção' : 'Nova Manutenção'}}
            </h4>
            <button class="btn-close-form" (click)="cancelarEdicao()">
              <mat-icon>close</mat-icon>
            </button>
          </div>
          <form [formGroup]="manutencaoForm">
            <div class="form-grid">
              <!-- Veículo -->
              <div class="form-group">
                <label>Veículo *</label>
                <mat-select formControlName="veiculo_id" class="form-control-select">
                  <mat-option *ngFor="let veiculo of veiculos" [value]="veiculo.id">
                    {{veiculo.matricula}} - {{veiculo.marca}} {{veiculo.modelo}} ({{veiculo.kilometragemAtual | number}} km)
                  </mat-option>
                </mat-select>
              </div>

              <!-- Tipo -->
              <div class="form-group">
                <label>Tipo de Manutenção *</label>
                <mat-select formControlName="tipoManutencao" class="form-control-select">
                  <mat-option *ngFor="let tipo of tiposManutencao" [value]="tipo">
                    {{getTipoManutencaoLabel(tipo)}}
                  </mat-option>
                </mat-select>
              </div>

              <!-- Data -->
              <div class="form-group">
                <label>Data da Manutenção *</label>
                <input matInput [matDatepicker]="picker" formControlName="dataManutencao" class="form-control">
                <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
                <mat-datepicker #picker></mat-datepicker>
              </div>

              <!-- Quilometragem -->
              <div class="form-group">
                <label>Quilometragem (km) *</label>
                <input matInput type="number" formControlName="kilometragemVeiculo" class="form-control">
              </div>

              <!-- Custo -->
              <div class="form-group">
                <label>Custo (R$) *</label>
                <input matInput type="number" step="0.01" formControlName="custo" class="form-control">
              </div>

              <!-- Próxima KM -->
              <div class="form-group">
                <label>Próxima Manutenção (km)</label>
                <input matInput type="number" formControlName="proximaManutencaoKm" class="form-control">
              </div>

              <!-- Próxima Data -->
              <div class="form-group">
                <label>Próxima Manutenção (data)</label>
                <input matInput [matDatepicker]="pickerProxima" formControlName="proximaManutencaoData" class="form-control">
                <mat-datepicker-toggle matSuffix [for]="pickerProxima"></mat-datepicker-toggle>
                <mat-datepicker #pickerProxima></mat-datepicker>
              </div>

              <!-- Botão calcular automático -->
              <div class="form-group">
                <button class="btn-calc" (click)="calcularProximaManutencao()">
                  <mat-icon>calculate</mat-icon>
                  Calcular Automático
                </button>
              </div>

              <!-- Descrição -->
              <div class="form-group full-width">
                <label>Descrição *</label>
                <textarea matInput formControlName="descricao" rows="3" class="form-control" placeholder="Descreva os serviços realizados..."></textarea>
              </div>
            </div>
          </form>
          <div class="form-actions">
            <button class="btn-save" (click)="salvarManutencao()" [disabled]="manutencaoForm.invalid || carregando">
              <mat-icon>save</mat-icon>
              {{editando ? 'Atualizar' : 'Salvar'}}
            </button>
            <button class="btn-cancel" (click)="cancelarEdicao()">
              <mat-icon>cancel</mat-icon>
              Cancelar
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Filtros -->
    <div class="filter-section">
      <div class="card">
        <div class="card-body">
          <h4 class="card-title">
            <mat-icon class="me-2">filter_list</mat-icon>
            Filtros
          </h4>
          <div class="filter-grid">
            <!-- Veículo -->
            <div class="filter-group">
              <label>Veículo</label>
              <input matInput [(ngModel)]="filtroVeiculo" placeholder="Matrícula ou modelo" class="form-control">
            </div>

            <!-- Tipo -->
            <div class="filter-group">
              <label>Tipo</label>
              <mat-select [(ngModel)]="filtroTipo" class="form-control-select">
                <mat-option value="">Todos</mat-option>
                <mat-option *ngFor="let tipo of tiposManutencao" [value]="tipo">
                  {{getTipoManutencaoLabel(tipo)}}
                </mat-option>
              </mat-select>
            </div>

            <!-- Status -->
            <div class="filter-group">
              <label>Status</label>
              <mat-select [(ngModel)]="filtroStatus" class="form-control-select">
                <mat-option value="">Todos</mat-option>
                <mat-option value="OK">OK</mat-option>
                <mat-option value="PROXIMA">Próxima</mat-option>
                <mat-option value="VENCIDA">Vencida</mat-option>
                <mat-option value="URGENTE">Urgente</mat-option>
              </mat-select>
            </div>

            <!-- Data Início -->
            <div class="filter-group">
              <label>Data Início</label>
              <input matInput [matDatepicker]="pickerInicio" [(ngModel)]="filtroDataInicio" class="form-control">
              <mat-datepicker-toggle matSuffix [for]="pickerInicio"></mat-datepicker-toggle>
              <mat-datepicker #pickerInicio></mat-datepicker>
            </div>

            <!-- Data Fim -->
            <div class="filter-group">
              <label>Data Fim</label>
              <input matInput [matDatepicker]="pickerFim" [(ngModel)]="filtroDataFim" class="form-control">
              <mat-datepicker-toggle matSuffix [for]="pickerFim"></mat-datepicker-toggle>
              <mat-datepicker #pickerFim></mat-datepicker>
            </div>
          </div>
          <div class="filter-actions">
            <button class="btn-apply" (click)="aplicarFiltros()" [disabled]="carregando">
              <mat-icon>search</mat-icon>
              Aplicar Filtros
            </button>
            <button class="btn-clear" (click)="limparFiltros()">
              <mat-icon>clear</mat-icon>
              Limpar Filtros
            </button>
          </div>
        </div>
      </div>
    </div>
    <!--Resumo-->
    <!-- Resumo -->
<div class="summary-section" *ngIf="!carregando && manutencoes.length > 0">
  <div class="card">
    <div class="card-body">
      <h4 class="card-title">
        <mat-icon class="me-2">assessment</mat-icon>
        Resumo das Manutenções
      </h4>
      <div class="summary-grid">
        <!-- Total de Manutenções -->
        <div class="summary-item">
          <div class="summary-icon total">
            <mat-icon>build</mat-icon>
          </div>
          <div class="summary-content">
            <span class="summary-label">Total de Manutenções</span>
            <span class="summary-value">{{getTotalCount()}}</span>
            <span class="summary-trend">Registradas</span>
          </div>
        </div>

        <!-- Custo Total -->
        <div class="summary-item">
          <div class="summary-icon cost">
            <mat-icon>attach_money</mat-icon>
          </div>
          <div class="summary-content">
            <span class="summary-label">Custo Total</span>
            <span class="summary-value">{{formatarMoeda(getTotalCusto())}}</span>
            <span class="summary-trend">Investido</span>
          </div>
        </div>

        <!-- Manutenções Vencidas -->
        <div class="summary-item">
          <div class="summary-icon overdue">
            <mat-icon>warning</mat-icon>
          </div>
          <div class="summary-content">
            <span class="summary-label">Manutenções Vencidas</span>
            <span class="summary-value">{{getVencidasCount()}}</span>
            <span class="summary-trend">Necessitam atenção</span>
          </div>
        </div>

        <!-- Manutenções Próximas -->
        <div class="summary-item">
          <div class="summary-icon upcoming">
            <mat-icon>schedule</mat-icon>
          </div>
          <div class="summary-content">
            <span class="summary-label">Manutenções Próximas</span>
            <span class="summary-value">{{getProximasCount()}}</span>
            <span class="summary-trend">A programar</span>
          </div>
        </div>

        <!-- Custo Médio -->
        <div class="summary-item">
          <div class="summary-icon average">
            <mat-icon>trending_up</mat-icon>
          </div>
          <div class="summary-content">
            <span class="summary-label">Custo Médio</span>
            <span class="summary-value">{{formatarMoeda(getCustoMedio())}}</span>
            <span class="summary-trend">Por manutenção</span>
          </div>
        </div>

        <!-- Status Geral -->
        <div class="summary-item">
          <div class="summary-icon status">
            <mat-icon>check_circle</mat-icon>
          </div>
          <div class="summary-content">
            <span class="summary-label">Status Geral</span>
            <span class="summary-value status-text {{getStatusGeral().toLowerCase()}}">
              {{getStatusGeralText()}}
            </span>
            <span class="summary-trend">{{getPercentualOK()}}% OK</span>
          </div>
        </div>
      </div>

      <!-- Detalhamento por Tipo -->
      <div class="type-breakdown mt-4">
        <h5 class="breakdown-title">
          <mat-icon class="me-2">pie_chart</mat-icon>
          Distribuição por Tipo
        </h5>
        <div class="breakdown-grid">
          <div *ngFor="let tipo of getTiposDistribuicao()" class="breakdown-item">
            <span class="breakdown-type">{{tipo.label}}</span>
            <div class="breakdown-bar">
              <div class="bar-fill" [style.width.%]="tipo.percentual" [class]="'fill-' + tipo.key"></div>
            </div>
            <span class="breakdown-count">{{tipo.count}} ({{tipo.percentual}}%)</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

    <!-- Tabela -->
    <div class="table-container" *ngIf="manutencoes && manutencoes.length > 0; else emptyState">
      <div class="table-header-info">
        <span class="total-registros">
          Total de manutenções: <strong>{{dataSource.filteredData.length}}</strong>
          <span class="text-muted ms-2">
            Custo total: {{formatarMoeda(getTotalCusto())}}
          </span>
        </span>
      </div>
      <table class="manutencoes-table">
        <thead>
          <tr class="table-header">
            <th>Veículo</th>
            <th>Tipo</th>
            <th>Data</th>
            <th>Quilometragem</th>
            <th>Custo</th>
            <th>Próxima Manutenção</th>
            <th>Status</th>
            <th class="actions-header">Ações</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let manutencao of dataSource.filteredData" class="table-row">
            <!-- Coluna Veículo -->
            <td class="veiculo-cell">
              <div class="veiculo-info">
                <mat-icon class="veiculo-icon">directions_car</mat-icon>
                <div class="veiculo-detalhes">
                  <strong>{{manutencao.veiculo?.matricula || 'N/A'}}</strong>
                  <span>{{manutencao.veiculo?.marca?.nome}} {{manutencao.veiculo?.modelo || ''}}</span>
                </div>
              </div>
            </td>

            <!-- Coluna Tipo -->
            <td class="tipo-cell">
              <span class="tipo-badge {{manutencao.tipoManutencao?.toLowerCase()}}">
                {{getTipoManutencaoLabel(manutencao.tipoManutencao)}}
              </span>
            </td>

            <!-- Coluna Data -->
            <td class="data-cell">
              {{formatarData(manutencao.dataManutencao)}}
            </td>

            <!-- Coluna Quilometragem -->
            <td class="km-cell">
              <span class="km-badge">{{(manutencao.kilometragemVeiculo || 0) | number:'1.0-0'}} km</span>
            </td>

            <!-- Coluna Custo -->
            <td class="custo-cell">
              {{formatarMoeda(manutencao.custo)}}
            </td>

            <!-- Coluna Próxima Manutenção -->
            <td class="proxima-cell">
              <div *ngIf="manutencao.proximaManutencaoData || manutencao.proximaManutencaoKm; else semProxima">
                <div *ngIf="manutencao.proximaManutencaoData" class="proxima-data">
                  {{formatarData(manutencao.proximaManutencaoData)}}
                </div>
                <div *ngIf="manutencao.proximaManutencaoKm" class="proxima-km">
                  {{manutencao.proximaManutencaoKm | number:'1.0-0'}} km
                </div>
              </div>
              <ng-template #semProxima>
                <span class="sem-proxima">Não definida</span>
              </ng-template>
            </td>

            <!-- Coluna Status -->
            <td class="status-cell">
              <span class="status-badge status-{{verificarStatusManutencao(manutencao).toLowerCase()}}">
                {{getStatusText(verificarStatusManutencao(manutencao))}}
              </span>
            </td>

            <!-- Coluna Ações -->
            <td class="actions-cell">
              <button class="btn-view" (click)="verDetalhes(manutencao)" title="Detalhes">
                <mat-icon>visibility</mat-icon>
              </button>
              <button class="btn-edit" (click)="editarManutencao(manutencao)" title="Editar">
                <mat-icon>edit</mat-icon>
              </button>
              <button class="btn-delete" (click)="excluirManutencao(manutencao)" title="Excluir">
                <mat-icon>delete</mat-icon>
              </button>
            </td>
          </tr>
        </tbody>
      </table>

      <!-- Paginação -->
      <div class="pagination-container">
        <mat-paginator [pageSizeOptions]="[5, 10, 25, 50]" showFirstLastButtons></mat-paginator>
      </div>
    </div>

    <!-- Empty State -->
    <ng-template #emptyState>
      <div class="empty-state">
        <mat-icon class="empty-icon">build</mat-icon>
        <h3>Nenhuma manutenção encontrada</h3>
        <p *ngIf="filtroVeiculo || filtroTipo || filtroStatus">
          Não foram encontradas manutenções com os filtros aplicados
        </p>
        <p *ngIf="!filtroVeiculo && !filtroTipo && !filtroStatus">
          Comece registrando sua primeira manutenção
        </p>
        <button class="btn-add-empty" (click)="novaManutencao()">
          <mat-icon>add</mat-icon>
          Nova Manutenção
        </button>
      </div>
    </ng-template>
  </div>
</div>
