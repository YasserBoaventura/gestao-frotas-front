<div class="manutencoes-container">
  <!-- Overlay e Modais -->
  <div class="modal-overlay" *ngIf="mostrarModal || mostrarModalAcao" (click)="fecharModal()">
    <!-- Modal de Cadastro/Edição -->
    <div *ngIf="mostrarModal" class="modal-form" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <div class="modal-title">
          <mat-icon class="modal-icon">{{editando ? 'edit' : 'add'}}</mat-icon>
          <h2>{{editando ? 'Editar Manutenção' : 'Nova Manutenção'}}</h2>
        </div>
        <button class="btn-close" (click)="fecharModal()">
          <mat-icon>close</mat-icon>
        </button>
      </div>

      <div class="modal-content">
        <form [formGroup]="manutencaoForm" class="form-grid">
          <!-- Veículo -->
          <div class="form-group">
            <label class="form-label">Veículo *</label>
            <mat-select formControlName="veiculo_id" class="form-control-select">
              <mat-option value="">Selecione um veículo</mat-option>
              <mat-option *ngFor="let veiculo of veiculos" [value]="veiculo.id">
                {{veiculo.matricula}} - {{veiculo.marca.nome}} {{veiculo.modelo}} ({{veiculo.kilometragemAtual | number}} km)
              </mat-option>
            </mat-select>
            <div class="form-error" *ngIf="manutencaoForm.get('veiculo_id')?.invalid && manutencaoForm.get('veiculo_id')?.touched">
              Veículo é obrigatório
            </div>
          </div>

          <!-- Tipo -->
          <div class="form-group">
            <label class="form-label">Tipo de Manutenção *</label>
            <mat-select formControlName="tipoManutencao" class="form-control-select">
              <mat-option value="">Selecione um tipo</mat-option>
              <mat-option *ngFor="let tipo of tiposManutencao" [value]="tipo">
                {{getTipoManutencaoLabel(tipo)}}
              </mat-option>
            </mat-select>
            <div class="form-error" *ngIf="manutencaoForm.get('tipoManutencao')?.invalid && manutencaoForm.get('tipoManutencao')?.touched">
              Tipo é obrigatório
            </div>
          </div>

          <!-- Data -->
          <div class="form-group">
            <label class="form-label">Data da Manutenção *</label>
            <input matInput [matDatepicker]="picker" formControlName="dataManutencao" class="form-control">
            <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
            <mat-datepicker #picker></mat-datepicker>
            <div class="form-error" *ngIf="manutencaoForm.get('dataManutencao')?.invalid && manutencaoForm.get('dataManutencao')?.touched">
              Data é obrigatória
            </div>
          </div>

          <!-- Quilometragem -->
          <div class="form-group">
            <label class="form-label">Quilometragem (km) *</label>
            <input matInput type="number" formControlName="kilometragemVeiculo" class="form-control">
            <div class="form-error" *ngIf="manutencaoForm.get('kilometragemVeiculo')?.invalid && manutencaoForm.get('kilometragemVeiculo')?.touched">
              Quilometragem é obrigatória
            </div>
          </div>

          <!-- Custo -->
          <div class="form-group">
            <label class="form-label">Custo (R$) *</label>
            <input matInput type="number" step="0.01" formControlName="custo" class="form-control">
            <div class="form-error" *ngIf="manutencaoForm.get('custo')?.invalid && manutencaoForm.get('custo')?.touched">
              Custo é obrigatório
            </div>
          </div>

          <!-- Status (só na edição) -->
          <div class="form-group" *ngIf="editando">
            <label class="form-label">Status</label>
            <mat-select formControlName="status" class="form-control-select">
              <mat-option value="PENDENTE">Pendente</mat-option>
              <mat-option value="EM_ANDAMENTO">Em Andamento</mat-option>
              <mat-option  value="URGENTE"> Urgente</mat-option>
              <mat-option value="CONCLUIDA">Concluída</mat-option>
              <mat-option value="CANCELADA">Cancelada</mat-option>
            </mat-select>
          </div>

          <!-- Próxima KM -->
          <div class="form-group">
            <label class="form-label">Próxima Manutenção (km)</label>
            <input matInput type="number" formControlName="proximaManutencaoKm" class="form-control">
          </div>

          <!-- Próxima Data -->
          <div class="form-group">
            <label class="form-label">Próxima Manutenção (data)</label>
            <input matInput [matDatepicker]="pickerProxima" formControlName="proximaManutencaoData" class="form-control">
            <mat-datepicker-toggle matSuffix [for]="pickerProxima"></mat-datepicker-toggle>
            <mat-datepicker #pickerProxima></mat-datepicker>
          </div>

          <!-- Botão calcular automático -->
          <div class="form-group">
            <button type="button" class="btn-calc" (click)="calcularProximaManutencao()">
              <mat-icon>calculate</mat-icon>
              Calcular Automático
            </button>
          </div>

          <!-- Descrição -->
          <div class="form-group full-width">
            <label class="form-label">Descrição *</label>
            <textarea matInput formControlName="descricao" rows="3" class="form-control" placeholder="Descreva os serviços realizados..."></textarea>
            <div class="form-error" *ngIf="manutencaoForm.get('descricao')?.invalid && manutencaoForm.get('descricao')?.touched">
              Descrição é obrigatória (mínimo 5 caracteres)
            </div>
          </div>
        </form>
      </div>

      <div class="modal-footer">
        <button class="btn-cancel" (click)="fecharModal()">
          <mat-icon>cancel</mat-icon>
          Cancelar
        </button>
        <button class="btn-save" (click)="salvarManutencao()" [disabled]="manutencaoForm.invalid || carregandoModal">
          <mat-icon *ngIf="!carregandoModal">save</mat-icon>
          <span *ngIf="carregandoModal" class="spinner-border spinner-border-sm"></span>
          {{editando ? 'Atualizar' : 'Salvar'}}
        </button>
      </div>
    </div>

    <!-- Modal de Ações -->
    <div *ngIf="mostrarModalAcao && tipoAcao && manutencaoSelecionada" class="modal-acao" (click)="$event.stopPropagation()">
      <div class="modal-header" [style.background]="getCorAcao()">
        <div class="modal-title">
          <mat-icon class="modal-icon">{{getIconeAcao()}}</mat-icon>
          <h2>{{getTituloAcao()}}</h2>
        </div>
        <button class="btn-close" (click)="fecharModal()">
          <mat-icon>close</mat-icon>
        </button>
      </div>

      <div class="modal-content">
        <div class="acao-content">
          <div class="acao-icon" [style.color]="getCorAcao()">
            <mat-icon>{{getIconeAcao()}}</mat-icon>
          </div>

          <h3>{{getTituloAcao()}}</h3>

          <div class="acao-info">
            <p><strong>Veículo:</strong> {{manutencaoSelecionada.veiculo?.matricula || 'N/A'}}</p>
            <p><strong>Tipo:</strong> {{getTipoManutencaoLabel(manutencaoSelecionada.tipoManutencao)}}</p>
            <p><strong>Data:</strong> {{formatarData(manutencaoSelecionada.dataManutencao)}}</p>
          </div>

          <!-- Campos específicos por ação -->
          <div *ngIf="tipoAcao === 'concluir'" class="acao-field">
            <label class="form-label">Observações (opcional)</label>
            <textarea [(ngModel)]="observacoes" rows="3" class="form-control"
                      placeholder="Adicione observações sobre a conclusão..."></textarea>
          </div>

          <div *ngIf="tipoAcao === 'cancelar'" class="acao-field">
            <label class="form-label">Motivo do Cancelamento *</label>
            <textarea [(ngModel)]="motivoCancelamento" rows="3" class="form-control"
                      placeholder="Informe o motivo do cancelamento..." required></textarea>
            <div class="form-error" *ngIf="!motivoCancelamento">
              Motivo é obrigatório
            </div>
          </div>

          <div class="acao-warning" *ngIf="tipoAcao === 'iniciar'">
            <mat-icon>info</mat-icon>
            <span>A manutenção será marcada como "Em Andamento".</span>
          </div>

          <div class="acao-warning" *ngIf="tipoAcao === 'cancelar'">
            <mat-icon>warning</mat-icon>
            <span>Esta ação não pode ser desfeita.</span>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn-cancel" (click)="fecharModal()">
          <mat-icon>cancel</mat-icon>
          Cancelar
        </button>
        <button class="btn-confirm"
                (click)="confirmarAcao()"
                [disabled]="carregando || (tipoAcao === 'cancelar' && !motivoCancelamento)"
                [style.background]="getCorAcao()">
          <mat-icon *ngIf="!carregando">{{getIconeAcao()}}</mat-icon>
          <span *ngIf="carregando" class="spinner-border spinner-border-sm"></span>
          {{tipoAcao === 'iniciar' ? 'Iniciar' : tipoAcao === 'concluir' ? 'Concluir' : 'Cancelar'}}
        </button>
      </div>
    </div>
  </div>

  <!-- Header -->
  <div class="header">
    <div class="header-title">
      <mat-icon class="title-icon">build</mat-icon>
      <h2>Gerenciamento de Manutenções</h2>
    </div>
    <div class="header-actions">
      <button class="btn-reload" (click)="carregarDados()" [disabled]="carregando" title="Recarregar lista">
        <mat-icon>refresh</mat-icon>
      </button>
      <button class="btn-add" (click)="abrirModalCadastro()">
        <mat-icon>add</mat-icon>
        Nova Manutenção
      </button>
    </div>
  </div>

  <!-- Estado de Carregamento -->
  <div *ngIf="carregando" class="loading-state">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Carregando...</span>
    </div>
    <h3>Carregando manutenções...</h3>
    <p>Aguarde enquanto carregamos a lista de manutenções</p>
  </div>

  <!-- Conteúdo Principal (quando não está carregando) -->
  <div *ngIf="!carregando">
    <!-- Alertas -->
    <div *ngIf="alertas.length > 0" class="alert-section">
      <div class="card">
        <div class="card-body">
          <h4 class="card-title">
            <mat-icon class="me-2">notifications</mat-icon>
            Alertas de Manutenção
          </h4>
          <div class="alertas-list">
            <div *ngFor="let alerta of alertas" class="alerta-item">
              <mat-icon class="alerta-icon">warning</mat-icon>
              <span class="alerta-text">{{alerta}}</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Filtros -->
    <div class="filter-section">
      <div class="card">
        <div class="card-body">
          <h4 class="card-title">
            <mat-icon class="me-2">filter_list</mat-icon>
            Filtros
          </h4>
          <div class="filter-grid">
            <!-- Veículo -->
            <div class="filter-group">
              <label>Veículo</label>
              <input matInput [(ngModel)]="filtroVeiculo" placeholder="Matrícula ou modelo" class="form-control" (keyup.enter)="aplicarFiltros()">
            </div>

            <!-- Tipo -->
            <div class="filter-group">
              <label>Tipo</label>
              <mat-select [(ngModel)]="filtroTipo" class="form-control-select" (selectionChange)="aplicarFiltros()">
                <mat-option value="">Todos</mat-option>
                <mat-option *ngFor="let tipo of tiposManutencao" [value]="tipo">
                  {{getTipoManutencaoLabel(tipo)}}
                </mat-option>
              </mat-select>
            </div>

            <!-- Status -->
            <div class="filter-group">
              <label>Status</label>
              <mat-select [(ngModel)]="filtroStatus" class="form-control-select" (selectionChange)="aplicarFiltros()">
                <mat-option value="">Todos</mat-option>
                <mat-option value="PENDENTE">Pendente</mat-option>
                <mat-option value="EM_ANDAMENTO">Em Andamento</mat-option>
                <mat-option value="CONCLUIDA">Concluída</mat-option>
                <mat-option value="CANCELADA">Cancelada</mat-option>
              </mat-select>
            </div>
          </div>
          <div class="filter-actions">
            <button class="btn-apply" (click)="aplicarFiltros()" [disabled]="carregando">
              <mat-icon>search</mat-icon>
              Aplicar Filtros
            </button>
            <button class="btn-clear" (click)="limparFiltros()">
              <mat-icon>clear</mat-icon>
              Limpar Filtros
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Resumo -->
    <div class="summary-section" *ngIf="manutencoes.length > 0">
      <div class="card">
        <div class="card-body">
          <div class="summary-header">
            <h4 class="card-title">
              <mat-icon class="me-2">assessment</mat-icon>
              Resumo das Manutenções
            </h4>
          </div>

          <div class="summary-grid">
            <!-- Total de Manutenções -->
            <div class="summary-item">
              <div class="summary-icon total">
                <mat-icon>build</mat-icon>
              </div>
              <div class="summary-content">
                <span class="summary-label">Total de Manutenções</span>
                <span class="summary-value">{{getTotalCount()}}</span>
                <span class="summary-trend">Registradas</span>
              </div>
            </div>

            <!-- Custo Total -->
            <div class="summary-item">
              <div class="summary-icon cost">
                <mat-icon>attach_money</mat-icon>
              </div>
              <div class="summary-content">
                <span class="summary-label">Custo Total</span>
                <span class="summary-value">{{formatarMoeda(getTotalCusto())}}</span>
                <span class="summary-trend">Investido</span>
              </div>
            </div>

            <!-- Manutenções Vencidas -->
            <div class="summary-item">
              <div class="summary-icon overdue">
                <mat-icon>warning</mat-icon>
              </div>
              <div class="summary-content">
                <span class="summary-label">Manutenções Vencidas</span>
                <span class="summary-value">{{getVencidasCount()}}</span>
                <span class="summary-trend">Necessitam atenção</span>
              </div>
            </div>

            <!-- Manutenções Próximas -->
            <div class="summary-item">
              <div class="summary-icon upcoming">
                <mat-icon>schedule</mat-icon>
              </div>
              <div class="summary-content">
                <span class="summary-label">Manutenções Próximas</span>
                <span class="summary-value">{{getProximasCount()}}</span>
                <span class="summary-trend">A programar</span>
              </div>
            </div>

            <!-- Custo Médio -->
            <div class="summary-item">
              <div class="summary-icon average">
                <mat-icon>trending_up</mat-icon>
              </div>
              <div class="summary-content">
                <span class="summary-label">Custo Médio</span>
                <span class="summary-value">{{formatarMoeda(getCustoMedio())}}</span>
                <span class="summary-trend">Por manutenção</span>
              </div>
            </div>

            <!-- Status Geral -->
            <div class="summary-item">
              <div class="summary-icon status">
                <mat-icon>check_circle</mat-icon>
              </div>
              <div class="summary-content">
                <span class="summary-label">Status Geral</span>
                <span class="summary-value status-text {{getStatusGeral().toLowerCase()}}">
                  {{getStatusGeralText()}}
                </span>
                <span class="summary-trend">{{getPercentualOK()}}% OK</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Tabela -->
    <div class="table-container" *ngIf="manutencoes && manutencoes.length > 0; else emptyState">
      <div class="table-header-info">
        <span class="total-registros">
          Total de manutenções: <strong>{{dataSource.filteredData.length}}</strong>
          <span class="text-muted ms-2">
            Custo total: {{formatarMoeda(getTotalCusto())}}
          </span>
        </span>
      </div>
      <table class="manutencoes-table">
        <thead>
          <tr class="table-header">
            <th>Veículo</th>
            <th>Tipo</th>
            <th>Data</th>
            <th>Quilometragem</th>
            <th>Custo</th>
            <th>Próxima Manutenção</th>
            <th>Status</th>
            <th class="actions-header">Ações</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let manutencao of dataSource.filteredData" class="table-row">
            <!-- Coluna Veículo -->
            <td class="veiculo-cell">
              <div class="veiculo-info">
                <mat-icon class="veiculo-icon">directions_car</mat-icon>
                <div class="veiculo-detalhes">
                  <strong>{{manutencao.veiculo?.matricula || 'N/A'}}</strong>
                  <span>{{manutencao.veiculo?.marca?.nome || manutencao.veiculo?.marca}} {{manutencao.veiculo?.modelo || ''}}</span>
                </div>
              </div>
            </td>

            <!-- Coluna Tipo -->
            <td class="tipo-cell">
              <span class="tipo-badge {{manutencao.tipoManutencao?.toLowerCase()}}">
                {{getTipoManutencaoLabel(manutencao.tipoManutencao)}}
              </span>
            </td>

            <!-- Coluna Data -->
            <td class="data-cell">
              {{formatarData(manutencao.dataManutencao)}}
            </td>

            <!-- Coluna Quilometragem -->
            <td class="km-cell">
              <span class="km-badge">{{(manutencao.kilometragemVeiculo || 0) | number:'1.0-0'}} km</span>
            </td>

            <!-- Coluna Custo -->
            <td class="custo-cell">
              {{formatarMoeda(manutencao.custo)}}
            </td>

            <!-- Coluna Próxima Manutenção -->
            <td class="proxima-cell">
              <div *ngIf="manutencao.proximaManutencaoData || manutencao.proximaManutencaoKm; else semProxima">
                <div *ngIf="manutencao.proximaManutencaoData" class="proxima-data">
                  {{formatarData(manutencao.proximaManutencaoData)}}
                </div>
                <div *ngIf="manutencao.proximaManutencaoKm" class="proxima-km">
                  {{manutencao.proximaManutencaoKm | number:'1.0-0'}} km
                </div>
              </div>
              <ng-template #semProxima>
                <span class="sem-proxima">Não definida</span>
              </ng-template>
            </td>

            <!-- Coluna Status -->
            <td class="status-cell">
              <span class="status-badge" [style.background-color]="getStatusColor(manutencao.status!)">
                {{getStatusLabel(manutencao.status!)}}
              </span>
            </td>

            <!-- Coluna Ações -->
            <td class="actions-cell">
              <button class="btn-view" (click)="verDetalhes(manutencao)" title="Detalhes">
                <mat-icon>visibility</mat-icon>
              </button>
              <button class="btn-edit" (click)="abrirModalCadastro(manutencao)" title="Editar">
                <mat-icon>edit</mat-icon>
              </button>

              <!-- Botões condicionais por status -->
            <button *ngIf="manutencao.status === 'ATRASADA' || manutencao.status === 'AGENDADA_HOJE'||
            manutencao.status === 'AGENDADA'"
              class="btn-success"
                      (click)="abrirModalAcao('iniciar', manutencao)" title="Iniciar Manutenção">
                <mat-icon>play_arrow</mat-icon>
              </button>

              <button *ngIf="manutencao.status === 'EM_ANDAMENTO'" class="btn-primary"
                      (click)="abrirModalAcao('concluir', manutencao)" title="Concluir Manutenção">
                <mat-icon>check_circle</mat-icon>
              </button>

              <button *ngIf="manutencao.status === 'PENDENTE' || manutencao.status === 'EM_ANDAMENTO'"
                      class="btn-warning" (click)="abrirModalAcao('cancelar', manutencao)" title="Cancelar Manutenção">
                <mat-icon>cancel</mat-icon>
              </button>

              <button class="btn-delete" (click)="excluirManutencao(manutencao)" title="Excluir">
                <mat-icon>delete</mat-icon>
              </button>
            </td>
          </tr>
        </tbody>
      </table>

      <!-- Paginação -->
      <div class="pagination-container">
        <mat-paginator [pageSizeOptions]="[5, 10, 25, 50]" showFirstLastButtons></mat-paginator>
      </div>
    </div>

    <!-- Empty State -->
    <ng-template #emptyState>
      <div class="empty-state">
        <mat-icon class="empty-icon">build</mat-icon>
        <h3>Nenhuma manutenção encontrada</h3>
        <p *ngIf="filtroVeiculo || filtroTipo || filtroStatus">
          Não foram encontradas manutenções com os filtros aplicados
        </p>
        <p *ngIf="!filtroVeiculo && !filtroTipo && !filtroStatus">
          Comece registrando sua primeira manutenção
        </p>
        <button class="btn-add-empty" (click)="abrirModalCadastro()">
          <mat-icon>add</mat-icon>
          Nova Manutenção
        </button>
      </div>
    </ng-template>
  </div>
</div>
