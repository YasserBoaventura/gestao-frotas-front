<div class="abastecimentos-container">
  <!-- Overlay e Modais -->
  <div class="modal-overlay" *ngIf="mostrarModal || mostrarModalExclusao" (click)="fecharModal()">
    <!-- Modal de Cadastro/Edição -->
    <div *ngIf="mostrarModal" class="modal-form" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <div class="modal-title">
          <mat-icon class="modal-icon">{{editando ? 'edit' : 'add'}}</mat-icon>
          <h2>{{editando ? 'Editar Abastecimento' : 'Novo Abastecimento'}}</h2>
        </div>
        <button class="btn-close" (click)="fecharModal()">
          <mat-icon>close</mat-icon>
        </button>
      </div>

      <div class="modal-content">
        <form [formGroup]="abastecimentoForm" class="form-grid">
          <!-- Veículo -->
          <div class="form-group">
            <label class="form-label">Veículo *</label>
            <mat-select formControlName="veiculoId" class="form-control-select"
                        (selectionChange)="onVeiculoChange($event.value)">
              <mat-option value="">Selecione um veículo</mat-option>
              <mat-option *ngFor="let veiculo of veiculos" [value]="veiculo.id">
                {{veiculo.matricula}} - {{veiculo.modelo}}
                <span *ngIf="veiculo.kilometragemAtual">
                  ({{veiculo.kilometragemAtual | number}} km)
                </span>
              </mat-option>
            </mat-select>
            <div class="form-error" *ngIf="abastecimentoForm.get('veiculoId')?.invalid && abastecimentoForm.get('veiculoId')?.touched">
              Veículo é obrigatório
            </div>
          </div>

          <!-- Viagem (Opcional) -->
          <div class="form-group">
            <label class="form-label">Viagem (Opcional)</label>
            <mat-select formControlName="viagemId" class="form-control-select">
              <mat-option value="">Não vinculada a viagem</mat-option>
              <mat-option *ngFor="let viagem of viagensDoVeiculo" [value]="viagem.id">
                #{{viagem.id}} - {{viagem.rota?.origem || 'Origem'}} → {{viagem.rota?.destino || 'Destino'}}
              </mat-option>
            </mat-select>
            <!-- Debug info -->
            <div class="debug-info" *ngIf="debugMode">
              <small>Viagens encontradas: {{viagensDoVeiculo.length}} | Veículo ID: {{abastecimentoForm.get('veiculoId')?.value}}</small>
            </div>
          </div>

          <!-- Data e Hora -->
          <div class="form-group">
            <label class="form-label">Data e Hora *</label>
            <input matInput type="datetime-local" formControlName="dataAbastecimento" class="form-control">
            <div class="form-error" *ngIf="abastecimentoForm.get('dataAbastecimento')?.invalid && abastecimentoForm.get('dataAbastecimento')?.touched">
              Data e hora são obrigatórias
            </div>
          </div>

          <!-- Tipo de Combustível -->
          <div class="form-group">
            <label class="form-label">Tipo de Combustível *</label>
            <mat-select formControlName="tipoCombustivel" class="form-control-select">
              <mat-option value="">Selecione um tipo</mat-option>
              <mat-option value="GASOLINA">Gasolina</mat-option>
              <mat-option value="DIESEL">Diesel</mat-option>
              <mat-option value="ETANOL">Etanol</mat-option>
              <mat-option value="GNV">GNV</mat-option>
              <mat-option value="ELETRICO">Elétrico</mat-option>
            </mat-select>
            <div class="form-error" *ngIf="abastecimentoForm.get('tipoCombustivel')?.invalid && abastecimentoForm.get('tipoCombustivel')?.touched">
              Tipo de combustível é obrigatório
            </div>
          </div>

          <!-- Status -->
          <div class="form-group">
            <label class="form-label">Status *</label>
            <mat-select formControlName="statusAbastecimento" class="form-control-select">
              <mat-option value="REALIZADA">Realizada</mat-option>
              <mat-option value="PLANEADA">Planejada</mat-option>
            </mat-select>
            <div class="form-error" *ngIf="abastecimentoForm.get('statusAbastecimento')?.invalid && abastecimentoForm.get('statusAbastecimento')?.touched">
              Status é obrigatório
            </div>
          </div>

          <!-- Quilometragem -->
          <div class="form-group">
            <label class="form-label">Quilometragem (km) *</label>
            <input matInput type="number" formControlName="kilometragemVeiculo"
                   class="form-control" (input)="calcularValorTotal()">
            <div class="form-error" *ngIf="abastecimentoForm.get('kilometragemVeiculo')?.invalid && abastecimentoForm.get('kilometragemVeiculo')?.touched">
              Quilometragem é obrigatória
            </div>
          </div>

          <!-- Quantidade de Litros -->
          <div class="form-group">
            <label class="form-label">Quantidade (L) *</label>
            <input matInput type="number" step="0.1" formControlName="quantidadeLitros"
                   class="form-control" (input)="calcularValorTotal()">
            <div class="form-error" *ngIf="abastecimentoForm.get('quantidadeLitros')?.invalid && abastecimentoForm.get('quantidadeLitros')?.touched">
              Quantidade é obrigatória
            </div>
          </div>

          <!-- Preço por Litro -->
          <div class="form-group">
            <label class="form-label">Preço por Litro (R$) *</label>
            <input matInput type="number" step="0.01" formControlName="precoPorLitro"
                   class="form-control" (input)="calcularValorTotal()">
            <div class="form-error" *ngIf="abastecimentoForm.get('precoPorLitro')?.invalid && abastecimentoForm.get('precoPorLitro')?.touched">
              Preço é obrigatório
            </div>
          </div>

          <!-- Valor Total (Calculado) -->
          <div class="form-group full-width">
            <label class="form-label">Valor Total</label>
            <div class="valor-total-display">
              <mat-icon class="valor-icon">attach_money</mat-icon>
              <span class="valor-text">{{valorCalculado | currency:'BRL':'symbol':'1.2-2'}}</span>
            </div>
          </div>
        </form>
      </div>

      <div class="modal-footer">
        <button class="btn-cancel" (click)="fecharModal()">
          <mat-icon>cancel</mat-icon>
          Cancelar
        </button>
        <button class="btn-save" (click)="salvarAbastecimento()"
                [disabled]="abastecimentoForm.invalid || carregandoModal">
          <mat-icon *ngIf="!carregandoModal">save</mat-icon>
          <span *ngIf="carregandoModal" class="spinner-border spinner-border-sm"></span>
          {{editando ? 'Atualizar' : 'Salvar'}}
        </button>
      </div>
    </div>

    <!-- Modal de Confirmação de Exclusão -->
    <div *ngIf="mostrarModalExclusao" class="modal-acao" (click)="$event.stopPropagation()">
      <div class="modal-header" style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);">
        <div class="modal-title">
          <mat-icon class="modal-icon">warning</mat-icon>
          <h2>Confirmar Exclusão</h2>
        </div>
        <button class="btn-close" (click)="fecharModal()">
          <mat-icon>close</mat-icon>
        </button>
      </div>

      <div class="modal-content">
        <div class="acao-content">
          <div class="acao-icon" style="color: #ff6b6b;">
            <mat-icon>delete_forever</mat-icon>
          </div>

          <h3>Excluir Abastecimento</h3>

          <div class="acao-info" *ngIf="abastecimentoSelecionado">
            <p><strong>Veículo:</strong> {{getVeiculoInfo(abastecimentoSelecionado.veiculo_Id!)}}</p>
            <p><strong>Data:</strong> {{formatarDataHora(abastecimentoSelecionado.dataAbastecimento!)}}</p>
            <p><strong>Combustível:</strong> {{getTipoCombustivelLabel(abastecimentoSelecionado.tipoCombustivel)}}</p>
            <p><strong>Quantidade:</strong> {{abastecimentoSelecionado.quantidadeLitros}} L</p>
            <p><strong>Valor:</strong> {{formatarMoeda(abastecimentoSelecionado.quantidadeLitros * abastecimentoSelecionado.precoPorLitro)}}</p>
          </div>

          <div class="acao-warning">
            <mat-icon>error</mat-icon>
            <span>Esta ação não pode ser desfeita. O abastecimento será permanentemente excluído.</span>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn-cancel" (click)="fecharModal()">
          <mat-icon>cancel</mat-icon>
          Cancelar
        </button>
        <button class="btn-confirm" style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);"
                (click)="confirmarExclusao()" [disabled]="carregando">
          <mat-icon *ngIf="!carregando">delete</mat-icon>
          <span *ngIf="carregando" class="spinner-border spinner-border-sm"></span>
          Excluir
        </button>
      </div>
    </div>
  </div>

  <!-- Header -->
  <div class="header">
    <div class="header-title">
      <mat-icon class="title-icon">local_gas_station</mat-icon>
      <h2>Gerenciamento de Abastecimentos</h2>
    </div>
    <div class="header-actions">
      <!-- Debug button (temporário) -->
      <button *ngIf="debugMode" class="btn-debug"  title="Debug">
        <mat-icon>bug_report</mat-icon>
      </button>
      <button class="btn-reload" (click)="carregarDados()" [disabled]="carregando" title="Recarregar lista">
        <mat-icon>refresh</mat-icon>
      </button>
      <button class="btn-add" (click)="novoAbastecimento()">
        <mat-icon>add</mat-icon>
        Novo Abastecimento
      </button>
    </div>
  </div>

  <!-- Estado de Carregamento -->
  <div *ngIf="carregando && abastecimentos.length === 0" class="loading-state">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Carregando...</span>
    </div>
    <h3>Carregando abastecimentos...</h3>
    <p>Aguarde enquanto carregamos a lista de abastecimentos</p>
  </div>

  <!-- Conteúdo Principal (quando não está carregando) -->
  <div *ngIf="!carregando || abastecimentos.length > 0">
    <!-- Filtros -->
    <div class="filter-section">
      <div class="card">
        <div class="card-body">
          <h4 class="card-title">
            <mat-icon class="me-2">filter_list</mat-icon>
            Filtros
          </h4>
          <div class="filter-grid">
            <!-- Veículo -->
            <div class="filter-group">
              <label>Veículo</label>
              <input matInput [(ngModel)]="filtroVeiculo" placeholder="Matrícula ou modelo"
                     class="form-control" (keyup.enter)="aplicarFiltros()">
            </div>

            <!-- Tipo Combustível -->
            <div class="filter-group">
              <label>Tipo de Combustível</label>
              <mat-select [(ngModel)]="filtroTipoCombustivel" class="form-control-select"
                         (selectionChange)="aplicarFiltros()">
                <mat-option value="">Todos</mat-option>
                <mat-option value="GASOLINA">Gasolina</mat-option>
                <mat-option value="DIESEL">Diesel</mat-option>
                <mat-option value="ETANOL">Etanol</mat-option>
                <mat-option value="GNV">GNV</mat-option>
                <mat-option value="ELETRICO">Elétrico</mat-option>
              </mat-select>
            </div>

            <!-- Status -->
            <div class="filter-group">
              <label>Status</label>
              <mat-select [(ngModel)]="filtroStatus" class="form-control-select"
                         (selectionChange)="aplicarFiltros()">
                <mat-option value="">Todos</mat-option>
                <mat-option value="REALIZADA">Realizada</mat-option>
                <mat-option value="PLANEADA">Planejada</mat-option>
              </mat-select>
            </div>

            <!-- Data Início -->
            <div class="filter-group">
              <label>Data Início</label>
              <input matInput type="date" [(ngModel)]="filtroDataInicio"
                     class="form-control" (change)="aplicarFiltros()">
            </div>

            <!-- Data Fim -->
            <div class="filter-group">
              <label>Data Fim</label>
              <input matInput type="date" [(ngModel)]="filtroDataFim"
                     class="form-control" (change)="aplicarFiltros()">
            </div>
          </div>
          <div class="filter-actions">
            <button class="btn-apply" (click)="aplicarFiltros()" [disabled]="carregando">
              <mat-icon>search</mat-icon>
              Aplicar Filtros
            </button>
            <button class="btn-clear" (click)="limparFiltros()">
              <mat-icon>clear</mat-icon>
              Limpar Filtros
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Estatísticas -->
    <div class="summary-section" *ngIf="abastecimentos.length > 0">
      <div class="card">
        <div class="card-body">
          <div class="summary-header">
            <h4 class="card-title">
              <mat-icon class="me-2">assessment</mat-icon>
              Estatísticas de Abastecimento
            </h4>
          </div>

          <div class="summary-grid">
            <!-- Total de Abastecimentos -->
            <div class="summary-item">
              <div class="summary-icon total">
                <mat-icon>local_gas_station</mat-icon>
              </div>
              <div class="summary-content">
                <span class="summary-label">Total de Abastecimentos</span>
                <span class="summary-value">{{getTotalAbastecimentos()}}</span>
                <span class="summary-trend">Registrados</span>
              </div>
            </div>

            <!-- Litros Total -->
            <div class="summary-item">
              <div class="summary-icon litros">
                <mat-icon>water_drop</mat-icon>
              </div>
              <div class="summary-content">
                <span class="summary-label">Litros Total</span>
                <span class="summary-value">{{estatisticas.totalLitros | number:'1.0-0'}} L</span>
                <span class="summary-trend">Consumidos</span>
              </div>
            </div>

            <!-- Custo Total -->
            <div class="summary-item">
              <div class="summary-icon cost">
                <mat-icon>attach_money</mat-icon>
              </div>
              <div class="summary-content">
                <span class="summary-label">Custo Total</span>
                <span class="summary-value">{{formatarMoeda(estatisticas.totalGasto)}}</span>
                <span class="summary-trend">Investido</span>
              </div>
            </div>

            <!-- Preço Médio -->
            <div class="summary-item">
              <div class="summary-icon average">
                <mat-icon>trending_up</mat-icon>
              </div>
              <div class="summary-content">
                <span class="summary-label">Preço Médio/L</span>
                <span class="summary-value">{{formatarMoeda(estatisticas.mediaPreco)}}</span>
                <span class="summary-trend">Por litro</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Tabela -->
    <div class="table-container" *ngIf="filteredAbastecimentos && filteredAbastecimentos.length > 0; else emptyState">
      <div class="table-header-info">
        <span class="total-registros">
          Total de abastecimentos: <strong>{{filteredAbastecimentos.length}}</strong>
          <span class="text-muted ms-2">
            Litros totais: {{estatisticas.totalLitros | number:'1.0-0'}} L •
            Custo total: {{formatarMoeda(estatisticas.totalGasto)}}
          </span>
        </span>
      </div>
      <table class="abastecimentos-table">
        <thead>
          <tr class="table-header">
            <th>Data/Hora</th>
            <th>Veículo</th>
            <th>Combustível</th>
            <th>Quilometragem</th>
            <th>Quantidade</th>
            <th>Preço/L</th>
            <th>Valor Total</th>
            <th>Status</th>
            <th class="actions-header">Ações</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let abastecimento of filteredAbastecimentos | slice: (pageIndex * pageSize):((pageIndex + 1) * pageSize)"
              class="table-row">
            <!-- Coluna Data/Hora -->
            <td class="data-cell">
              <div class="data-info">
                <div class="data-dia">{{formatarDataHora(abastecimento.dataAbastecimento!)}}</div>
              </div>
            </td>

            <!-- Coluna Veículo -->
      <td class="veiculo-cell">
  <div class="veiculo-info">
    <mat-icon class="veiculo-icon">directions_car</mat-icon>
    <div class="veiculo-detalhes">

      <div *ngIf="debugMode" class="debug-veiculo-id">
         Veículo Matricula: {{abastecimento.veiculo?.matricula}}
      </div>
      <span *ngIf="abastecimento.viagemId" class="viagem-info">
        <mat-icon class="small-icon">directions</mat-icon>
        Viagem #{{abastecimento.viagemId}}
      </span>
    </div>
  </div>
</td> 

            <!-- Coluna Combustível -->
            <td class="combustivel-cell">
              <span class="combustivel-badge {{abastecimento.tipoCombustivel?.toLowerCase()}}">
                {{getTipoCombustivelLabel(abastecimento.tipoCombustivel)}}
              </span>
            </td>

            <!-- Coluna Quilometragem -->
            <td class="km-cell">
              <div class="km-info">
                <mat-icon class="km-icon">speed</mat-icon>
                <span>{{abastecimento.kilometragemVeiculo | number:'1.0-0'}} km</span>
              </div>
            </td>

            <!-- Coluna Quantidade -->
            <td class="quantidade-cell">
              {{abastecimento.quantidadeLitros | number:'1.1-1'}} L
            </td>

            <!-- Coluna Preço por Litro -->
            <td class="preco-cell">
              {{formatarMoeda(abastecimento.precoPorLitro)}}
            </td>

            <!-- Coluna Valor Total -->
            <td class="valor-cell">
              <div class="valor-info">
                <mat-icon class="valor-icon">attach_money</mat-icon>
                <strong>{{formatarMoeda(abastecimento.quantidadeLitros * abastecimento.precoPorLitro)}}</strong>
              </div>
            </td>

            <!-- Coluna Status -->
            <td class="status-cell">
              <span class="status-badge" [style.background-color]="getStatusColor(abastecimento.statusAbastecimento!)">
                {{getStatusLabel(abastecimento.statusAbastecimento!)}}
              </span>
            </td>

            <!-- Coluna Ações -->
            <td class="actions-cell">
              <button class="btn-view" (click)="editarAbastecimento(abastecimento)" title="Editar">
                <mat-icon>edit</mat-icon>
              </button>
              <button class="btn-delete" (click)="confirmarExclusaoModal(abastecimento)" title="Excluir">
                <mat-icon>delete</mat-icon>
              </button>
            </td>
          </tr>
        </tbody>
      </table>

      <!-- Paginação -->
      <div class="pagination-container">
        <mat-paginator [length]="filteredAbastecimentos.length"
                      [pageSize]="pageSize"
                      [pageSizeOptions]="pageSizeOptions"
                      [pageIndex]="pageIndex"
                      (page)="onPageChange($event)"
                      showFirstLastButtons>
        </mat-paginator>
      </div>
    </div>

    <!-- Empty State -->
    <ng-template #emptyState>
      <div class="empty-state">
        <mat-icon class="empty-icon">local_gas_station</mat-icon>
        <h3>Nenhum abastecimento encontrado</h3>
        <p *ngIf="filtroVeiculo || filtroTipoCombustivel || filtroStatus || filtroDataInicio">
          Não foram encontrados abastecimentos com os filtros aplicados
        </p>
        <p *ngIf="!filtroVeiculo && !filtroTipoCombustivel && !filtroStatus && !filtroDataInicio">
          Comece registrando seu primeiro abastecimento
        </p>
        <button class="btn-add-empty" (click)="novoAbastecimento()">
          <mat-icon>add</mat-icon>
          Novo Abastecimento
        </button>
      </div>
    </ng-template>
  </div>
</div>
